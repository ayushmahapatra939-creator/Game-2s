<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Tic-Tac-Toe</title>
    <style>
        body { font-family: 'Arial', sans-serif; text-align: center; background: #f0f2f5; }
        .container { margin-top: 50px; }
        .board { display: grid; grid-template-columns: repeat(3, 100px); gap: 10px; justify-content: center; margin: 20px auto; }
        .cell { width: 100px; height: 100px; background: #fff; border: 2px solid #333; font-size: 2em; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 8px; }
        .cell:hover { background: #e9ecef; }
        .btn { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; margin: 5px; }
        #status { font-weight: bold; margin: 15px; color: #555; }
        input { padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
    </style>
</head>
<body>

<div class="container">
    <h1>Tic-Tac-Toe Online</h1>
    
    <div id="setup-screen">
        <button class="btn" onclick="createGame()">Create New Game</button>
        <p>OR</p>
        <input type="text" id="join-input" placeholder="Enter Room Code">
        <button class="btn" style="background: #28a745;" onclick="joinGame()">Join Game</button>
    </div>

    <div id="game-screen" style="display:none;">
        <h3>Room Code: <span id="room-id-display" style="color: #d9534f;"></span></h3>
        <p id="status">Waiting for opponent...</p>
        <div class="board" id="board">
            <div class="cell" onclick="handleMove(0)"></div>
            <div class="cell" onclick="handleMove(1)"></div>
            <div class="cell" onclick="handleMove(2)"></div>
            <div class="cell" onclick="handleMove(3)"></div>
            <div class="cell" onclick="handleMove(4)"></div>
            <div class="cell" onclick="handleMove(5)"></div>
            <div class="cell" onclick="handleMove(6)"></div>
            <div class="cell" onclick="handleMove(7)"></div>
            <div class="cell" onclick="handleMove(8)"></div>
        </div>
        <p>You are: <b id="player-tag">...</b></p>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

<script>
    // Firebase Configuration (Public Test DB)
    const firebaseConfig = {
        databaseURL: "https://tic-tac-toe-demo-6b3a2-default-rtdb.firebaseio.com/" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let roomId = null;
    let playerSymbol = null; // 'X' or 'O'
    let currentTurn = 'X';
    let boardState = Array(9).fill("");

    // --- Game Logic ---

    function createGame() {
        roomId = Math.floor(1000 + Math.random() * 9000); // 4 digit code
        playerSymbol = 'X';
        initGame();
    }

    function joinGame() {
        roomId = document.getElementById('join-input').value;
        if(!roomId) return alert("Enter a code!");
        playerSymbol = 'O';
        initGame();
    }

    function initGame() {
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'block';
        document.getElementById('room-id-display').innerText = roomId;
        document.getElementById('player-tag').innerText = playerSymbol;

        // Listen for data changes in Firebase
        db.ref('rooms/' + roomId).on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                boardState = data.board || Array(9).fill("");
                currentTurn = data.turn || 'X';
                updateUI();
                checkWinner();
            } else {
                // Initialize room in DB if creating
                if(playerSymbol === 'X') {
                    db.ref('rooms/' + roomId).set({ board: boardState, turn: 'X' });
                }
            }
        });
    }

    function handleMove(index) {
        if (boardState[index] === "" && currentTurn === playerSymbol) {
            boardState[index] = playerSymbol;
            const nextTurn = playerSymbol === 'X' ? 'O' : 'X';
            db.ref('rooms/' + roomId).update({
                board: boardState,
                turn: nextTurn
            });
        } else if (currentTurn !== playerSymbol) {
            alert("Wait for your turn!");
        }
    }

    function updateUI() {
        const cells = document.querySelectorAll('.cell');
        boardState.forEach((val, i) => {
            cells[i].innerText = val;
            cells[i].style.color = val === 'X' ? '#007bff' : '#d9534f';
        });
        document.getElementById('status').innerText = `Turn: ${currentTurn}`;
    }

    function checkWinner() {
        const wins = [[0,1,2], [3,4,5], [6,7,8], [0,3,6], [1,4,7], [2,5,8], [0,4,8], [2,4,6]];
        for (let combo of wins) {
            const [a, b, c] = combo;
            if (boardState[a] && boardState[a] === boardState[b] && boardState[a] === boardState[c]) {
                document.getElementById('status').innerText = `PLAYER ${boardState[a]} WINS! üéâ`;
                db.ref('rooms/' + roomId).off(); // Stop listening
                return;
            }
        }
        if (!boardState.includes("")) {
            document.getElementById('status').innerText = "IT'S A DRAW! ü§ù";
        }
    }

    // Auto-join if URL has ?room=1234
    const urlParams = new URLSearchParams(window.location.search);
    const roomFromUrl = urlParams.get('room');
    if(roomFromUrl) {
        document.getElementById('join-input').value = roomFromUrl;
        joinGame();
    }
</script>

</body>
</html>
